[回RedRock主目录页](../README.md)

# RedRock内存磁盘管理

## RedRock的内存和磁盘机理

RedRock是自动监视内存的使用情况，一旦发现内存超过某个阀值，它将在后台进行内存清理，采用LRU/LFU算法，让冷温数据入磁盘，热数据继续保留内存中。

这个阀值，在RedRock里叫maxrockmem。它有缺省配置，即你不配置时，它是当前操作系统的内存值，再减去2G内存。

比如：你的硬件配置是16G，那么当RedRock发现当前消耗的内存超过14G时，它将在后台定时将一些数据写入磁盘，从而腾出内存空间。

那么这个消耗的内存是什么？

这个消耗的内存空间，是通过Redis的内存分配库（编译配置中是deps/目录下的Jemalloc库）分配的内存，在没有写盘发生时，你可以理解它就是整个数据集的大小（同时也包括一些临TCP连接消耗以及临时的buffer，但一般不是太多，可忽略）。

但有一些内存，是不通过Redis进行分配的，比如：加载的代码。更麻烦的是：RocksDB。

当RedRock读写磁盘时，它是用RocksDB进行的，而RocksDB读写磁盘所用到的内存空间，并不好控制，因为涉及它的一个特性，compaction。

一般情况下，我们给RocksDB留出1G内存空间，大部分情况下都够用了。但如果发生RocksDB大量的读写和compaction，那么1G内存空间会不够，要多少，对不起，我不知道。如果你发现RedRock由于磁盘大量读写导致RocksDB所需内存远超过1G，从而发生操作系统Kill掉RedRock内存，那么，你就需要留出更多的内存给RocksDB，以应付高峰时刻。

我们还需要留出至少1G内存给操作系统工作。

这也是缺省情况下(maxrockmem == 0)，RedRock认为内存阀值是：操作系统内存 - 2G。

你可以更改RedRock这个参数maxrockmem，不用缺省值0，给maxrockmem一个足够安全的低值，留出更多的内存空间给RocksDB和操作系统，从而让RedRock更安全，更不易导致操作系统Kill服务器进程。具体多少，因为涉及每个应用程序实际的工作环境不一样，只有实践中不断调试和解决。

记住：这是个trade-off。

* 如果maxrockmem高，你就会有更多的内存给与热数据，从而不浪费内存，但缺点是，如果RedRock的RocksDB很忙，它会耗费大量的内存导致RedRcok进程被杀。
* 如果maxrockmem低，就留出更多的内存给RocksDB和操作系统使用，RedRcok进程就更安全，但坏处是：热数据所占用的内存会变少，即内存利用率不足。

你可能会问，RedRock不是有自动转储磁盘功能，从而腾出内存空间吗？

是的，RedRock是自动青睐内存，让多于内存写入磁盘，从而腾出更多的空间。

但是，这个转储是一个慢动作，因为涉及磁盘操作，同时我们也不能让主线程花费太多的时间处理（否则客户端的响应将会变慢），所以，如果有大量的新key注入，内存的增长速度会远远快于磁盘的写入速度，最后会导致写磁盘释放内存远远慢于新key的到来，那么最终会让内存不够，从而导致服务器进程被操作系统杀死（或者操作系统由于内存缺乏陷入死机状态）。

为了防止这种现象的发生，除了设置maxrockmem外，我们还有几个解救办法：

1. 设置maxrockpsmem

这样，一旦服务器进程内存超过这个限度，那么RedRock将拒绝新key的进入（也包括很多Redis的Write命令，因为它也可能导致内存增长，比如APPEND命令）

2. 提高后台的清理速度

这个可以设置hz这个配置参数，让RedRock更快去处理内存清理。但同样地，这是个trade-off，因为RedRock如果更多去处理内存清理，那么它对Redis客户端的响应时间就会变少，同时，再快的处理速度，也赶不上新来key的大量涌入

3. 用命令直接主动清理

RedRock提供了ROCKMEM等命令，可以主动清理内存。但这也是个trade-off，因为执行这个命令可能会需要不少时间，这个时间内，RedRock是无法响应其他客户端的其他命令。

所以，你只能用maxrockmem\maxrockpsmem\hz\ROCKMEM这几个工具，共同解决内存和大QPS的危机。没有一个是最好的，都有trade-off，根据你的应用情况，选择关键的参数或者组合才是最佳的。

预了解maxrockmem\maxrockpsmem\hz\ROCKMEM更多信息，详细可参考：[新增命令\配置参数\取消特性](manual.md)。

另外，当RedRock服务器是多个进程同时运行在一台硬件服务器上，或者操作系统里还有其他消耗内存的进程（比如Redis的redis-server），那么，你不能使用缺省的maxrockmem，因为这个参数是为单进程使用的环境准备的。

## Key和大Hash（Field）

## LRU和LFU算法



## 后台处理和前台命令

## 如何监测内存和磁盘情况

## 如何处理内存的一些问题



